'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var createMessenger = require('./create-messenger.js');
var constants = require('./constants.js');

function createNullOriginIframeMessenger(url) {
  return createMessenger.createIframeWorkerMessenger(url, iframe => {
    const iframeSource = `
    <html>
      <body>
        <script>
          window.addEventListener('message', function (event) {
            var data = event.data;
            if (data == null || typeof data.${constants.IFRAME_RUN_IDENTIFIER} !== 'string') return;

            var workerScript = URL.createObjectURL(
              new Blob(['importScripts(' + JSON.stringify(data.${constants.IFRAME_RUN_IDENTIFIER}) + ');']),
            );

            var worker = new Worker(workerScript);
            worker.postMessage({__replace: event.ports[0]}, [event.ports[0]]);
          });
        </script>
      </body>
    </html>
  `;
    iframe.setAttribute('sandbox', 'allow-scripts');
    iframe.srcdoc = iframeSource;
  });
}

exports.createNullOriginIframeMessenger = createNullOriginIframeMessenger;
